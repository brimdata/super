script: |
  super compile -C -I test.spq
  echo "==="
  super compile -dag -C -I test.spq

inputs:
  - name: test.spq
    data: |
      func fib(n): (n <= 1 ? n : fib(n-1) + fib(n-2))
      const foo = "bar"
      func add(a,b): (a+b)
      const bar = "baz"
      op stamp(assignee): ( yield {...this, assignee, ts: now()} )
      op nop(foo): ( pass )
      op joinTest(left_file, right_file, left_key, right_key, left_dest, right_source): (
        from [left_file]
        |> inner join (
          from [right_file]
        ) on left_key = right_key left_dest := right_source
      )
      joinTest("fruit.json", "people.json", flavor, likes, eater, name)
      |> stamp("bob")

outputs:
  - name: stdout
    data: |
      func fib(n): (
        (n<=1) ? n : fib(n-1)+fib(n-2)
      )
      const foo = "bar"
      func add(a, b): (
        a+b
      )
      const bar = "baz"
      op stamp(assignee): (
        yield {...this,assignee,ts:now()}
      )
      op nop(foo): (
        pass
      )
      op joinTest(left_file, right_file, left_key, right_key, left_dest, right_source): (
        from [left_file]
        |> join (
          from [right_file]
        ) on left_key=right_key left_dest:=right_source
      )
      joinTest("fruit.json", "people.json", flavor, likes, eater, name)
      |> stamp("bob")
      ===
      (
        const foo = "bar"
        const bar = "baz"
        func fib(n): (
          (n<=1) ? n : fib(n-1)+fib(n-2)
        )
        func add(a, b): (
          a+b
        )
        
        file fruit.json
        |> fork (
          =>
            pass
          =>
            file people.json
        )
        |> join on flavor=likes eater:=name
        |> yield {...this,assignee:"bob",ts:now()}
        |> output main
      )
