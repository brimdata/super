script: |
  source service.sh
  super db create -q test1
  super db create -q test2
  for file in multifrom.pipe agg.pipe agg-no-keys.pipe two-channels.pipe agg-sort.pipe scope.pipe auto-combined-channels.pipe; do
    echo // === $file ===
    query="$(cat $file | jq -Rsa .)"
    curl -H "Accept: application/json" -d "{\"query\":$query,\"head\":{\"pool\":\"test1\"}}" $SUPER_DB_LAKE/query/describe |
      super query -J -c 'sources := (over sources | id := "XXX")' -
  done


inputs:
  - name: service.sh
  - name: multifrom.pipe
    data: |
      from (
        pool test1
        pool test2
      ) | put foo := "bar"
  - name: agg.pipe
    data: |
      count() by key1:=v1, key2
  - name: agg-no-keys.pipe
    data: |
      sum(this)
  - name: two-channels.pipe
    data: |
      fork (
      => from test1 | sum(y) by key1 | output main
      => from test2 | put x := "foo" | output secondary
      )
  - name: agg-sort.pipe
    data: |
      sum(this) by foo | sort x
  - name: scope.pipe
    data: |
      type port = uint16
      from test1 | fork (=> output main => yield "bar" | output secondary)
  - name: auto-combined-channels.pipe
    data: |
      from test1 | fork (=> pass => pass)

outputs:
  - name: stdout
    data: |
      // === multifrom.pipe ===
      {
          "sources": [
              {
                  "kind": "Pool",
                  "name": "test1",
                  "id": "XXX",
                  "inferred": false
              },
              {
                  "kind": "Pool",
                  "name": "test2",
                  "id": "XXX",
                  "inferred": false
              }
          ],
          "channels": [
              {
                  "name": "main",
                  "aggregation_keys": null,
                  "sort": [
                      {
                          "order": "desc",
                          "key": [
                              "ts"
                          ]
                      }
                  ]
              }
          ]
      }
      // === agg.pipe ===
      {
          "sources": {
              "kind": "Pool",
              "name": "test1",
              "id": "XXX",
              "inferred": true
          },
          "channels": [
              {
                  "name": "main",
                  "aggregation_keys": [
                      [
                          "key1"
                      ],
                      [
                          "key2"
                      ]
                  ],
                  "sort": null
              }
          ]
      }
      // === agg-no-keys.pipe ===
      {
          "sources": {
              "kind": "Pool",
              "name": "test1",
              "id": "XXX",
              "inferred": true
          },
          "channels": [
              {
                  "name": "main",
                  "aggregation_keys": [],
                  "sort": null
              }
          ]
      }
      // === two-channels.pipe ===
      {
          "sources": [
              {
                  "kind": "Pool",
                  "name": "test1",
                  "id": "XXX",
                  "inferred": false
              },
              {
                  "kind": "Pool",
                  "name": "test2",
                  "id": "XXX",
                  "inferred": false
              }
          ],
          "channels": [
              {
                  "name": "main",
                  "aggregation_keys": [
                      [
                          "key1"
                      ]
                  ],
                  "sort": null
              },
              {
                  "name": "secondary",
                  "aggregation_keys": null,
                  "sort": [
                      {
                          "order": "desc",
                          "key": [
                              "ts"
                          ]
                      }
                  ]
              }
          ]
      }
      // === agg-sort.pipe ===
      {
          "sources": {
              "kind": "Pool",
              "name": "test1",
              "id": "XXX",
              "inferred": true
          },
          "channels": [
              {
                  "name": "main",
                  "aggregation_keys": [
                      [
                          "foo"
                      ]
                  ],
                  "sort": [
                      {
                          "order": "asc",
                          "key": [
                              "x"
                          ]
                      }
                  ]
              }
          ]
      }
      // === scope.pipe ===
      {
          "sources": {
              "kind": "Pool",
              "name": "test1",
              "id": "XXX",
              "inferred": false
          },
          "channels": [
              {
                  "name": "main",
                  "aggregation_keys": null,
                  "sort": [
                      {
                          "order": "desc",
                          "key": [
                              "ts"
                          ]
                      }
                  ]
              },
              {
                  "name": "secondary",
                  "aggregation_keys": null,
                  "sort": null
              }
          ]
      }
      // === auto-combined-channels.pipe ===
      {
          "sources": {
              "kind": "Pool",
              "name": "test1",
              "id": "XXX",
              "inferred": false
          },
          "channels": [
              {
                  "name": "main",
                  "aggregation_keys": null,
                  "sort": null
              }
          ]
      }
