script: |
  source service.sh
  zed create -q test
  zed use -q test
  id=$(zed load in.zson | awk '{print $1}')
  zed index create -q paths field _path
  zed index create -q srcip field srcip
  zed index apply -r srcip -r paths $id | sed -E 's/[0-9a-zA-Z]{27}/xxx/'
  echo ===
  zed query -Z -I query.zed

inputs:
  - name: service.sh
    source: ../service.sh
  - name: in.zson
    data: |
      {x:127.0.0.1}
      {x:127.0.0.2}
  - name: query.zed
    data: |
      from (
        pool :index_rules
        pool test@main:indexes => cut o:=this
      )
      | left join on id = o.rule.id o
      | count(o) by name, fields
      | sort name

outputs:
  - name: stderr
    data: ""
  - name: stdout
    data: |
      xxx committed
      ===
      {
          name: "paths",
          fields: [
              [
                  "_path"
              ] (=field.Path)
          ] (=field.List),
          count: 1 (uint64)
      }
      {
          name: "srcip",
          fields: [
              [
                  "srcip"
              ] (=field.Path)
          ] (=field.List),
          count: 1 (uint64)
      }
